[mysqld]
# Percona Server 8.4 with MyRocks - BULK LOAD CONFIGURATION
# Tuned for: 24 CPU cores, 64GB RAM, 1.9TB NVMe SSD
#
# WARNING: These settings prioritize speed over durability.
# Use only for data preparation, not for benchmarking or production.
#
# Strategy: Normal write path (memtable -> flush -> compaction) with
# rocksdb_commit_in_the_middle to bound transaction memory.
#
# Why NOT rocksdb_bulk_load: tpcc_load interleaves inserts across ORDER,
# NEW_ORDER, and ORDER_LINE tables per order. With bulk_load=1, each
# table switch triggers SST file creation and ingestion. This produces
# ~60M tiny SST ingestions for 2000 warehouses, stalling the server and
# dropping client connections (error 2013).
# See: https://docs.percona.com/percona-server/8.0/data-loading.html
user = mysql
port = 3306
socket = /tmp/mysql_percona_myrocks.sock
pid-file = /tmp/mysql_percona_myrocks.pid
datadir = /mnt/nvme/mysql-percona-myrocks/data

# Storage Engine
default-storage-engine = ROCKSDB

# Load RocksDB Plugin
plugin-load-add = ha_rocksdb.so

# Transaction and Collation Settings (recommended for MyRocks)
transaction-isolation = READ-COMMITTED
character-set-server = latin1
collation-server = latin1_bin

# Binary log (ROW format)
binlog_format = ROW

# Disable query logging
slow_query_log = 0
general_log = 0

# Disable Performance Schema
performance_schema = OFF

# ============================================
# WRITE PATH
# ============================================

# We use the default write path (memtable -> flush -> compaction) rather than
# rocksdb_bulk_load=1. While bulk_load is faster (writes directly to SST files),
# it doesn't work with our benchmarks:
#   - sysbench-tpcc: INSERT...SELECT triggers gap lock errors, and Percona
#     Server 8.4 has no variable to disable gap lock checking (unlike MariaDB)
#   - tpcc-mysql: interleaved multi-table inserts cause millions of tiny SST
#     file ingestions, stalling the server

# Commit every rocksdb_bulk_load_size rows to bound transaction memory.
# Without this or bulk_load, all modifications stay in memory -> OOM.
rocksdb_commit_in_the_middle = 1
rocksdb_bulk_load_size = 5000

# ============================================
# WRITE BUFFERS
# ============================================

# Total write buffer across all column families (~6% of 64GB).
# Larger = fewer flushes = less write stall risk during heavy inserts.
rocksdb_db_write_buffer_size = 4G

# Per-CF: 512MB buffers, up to 8 before stalling foreground writes.
# Gives 4GB per CF before write stall, matching the global limit.
# No compression for fair architectural comparison with InnoDB.
rocksdb_default_cf_options = write_buffer_size=512m;max_write_buffer_number=8;compression=kNoCompression

# ============================================
# CONCURRENCY (tuned for 24 cores)
# ============================================

# Parallel memtable writes from multiple loader processes
rocksdb_allow_concurrent_memtable_write = ON

# Write batch leader yields before blocking, reducing mutex contention
rocksdb_enable_write_thread_adaptive_yield = ON

# 12 of 24 cores for background flush/compaction.
# Leaves 12 cores for foreground loader threads.
rocksdb_max_background_jobs = 12

# Parallelize large compactions into sub-tasks
rocksdb_max_subcompactions = 4

# ============================================
# I/O
# ============================================

# Keep all SST file handles open (avoid open/close overhead)
rocksdb_max_open_files = -1

# No rate limiting during data load
rocksdb_rate_limiter_bytes_per_sec = 0

# Async data sync every 4MB (avoid large burst syncs)
rocksdb_bytes_per_sync = 4194304
rocksdb_wal_bytes_per_sync = 4194304

# Block cache minimal during load (no read workload)
rocksdb_block_cache_size = 512M

# ============================================
# DURABILITY (all relaxed for load speed)
# ============================================

# No WAL sync per commit
rocksdb_flush_log_at_trx_commit = 0

# No binlog sync per commit
sync_binlog = 0

# ============================================
# CONNECTIONS / TIMEOUTS
# ============================================

max_connections = 200

net_read_timeout = 3600
net_write_timeout = 3600
wait_timeout = 28800
interactive_timeout = 28800

# ============================================
# BUFFERS
# ============================================

sort_buffer_size = 64M
read_buffer_size = 16M

[client]
socket = /tmp/mysql_percona_myrocks.sock
